
{% extends "base.html" %}

{% block title %}Earn Cookies - MCCookies{% endblock %}

{% block content %}
<div class="earn-container">
    <!-- Header -->
    <div class="earn-header">
        <h1>üç™ EARN COOKIES</h1>
        <p>Complete offers from verified partners and earn cookies instantly!</p>
        <div class="user-stats">
            <div class="stat-item">
                <span class="stat-number">{{ user_data.cookies if user_data else 0 }}</span>
                <span class="stat-label">Your Cookies</span>
            </div>
            <div class="stat-item">
                <span class="stat-number">{{ completions_count if completions_count else 0 }}</span>
                <span class="stat-label">Completed Today</span>
            </div>
        </div>
    </div>

    <!-- Instructions -->
    <div class="instructions-card">
        <h3>üìã How to Earn</h3>
        <div class="instruction-steps">
            <span>1. Choose an offer below</span>
            <span>2. Click "Get Link" to start</span>
            <span>3. Complete the offer task</span>
            <span>4. Cookies added automatically!</span>
        </div>
    </div>

    <!-- Earning Options Grid -->
    <div class="earning-options">
        {% for service, config in shorteners.items() %}
        <div class="earning-option-card" data-service="{{ service }}">
            <div class="card-header" style="background: {{ config.color }};">
                <h3>{{ config.name }}</h3>
                <div class="reward-badge">üç™ {{ config.reward }}</div>
            </div>
            <div class="card-body">
                <div class="service-info">
                    <p>{{ config.description if config.description else 'Complete offers and earn cookies' }}</p>
                    <div class="service-stats">
                        <span>‚è±Ô∏è ~2-3 minutes</span>
                        <span>‚úÖ Auto-verified</span>
                    </div>
                </div>
                
                {% set user_id = session.user_id %}
                {% set can_earn = True %}
                {% set cooldown_remaining = 0 %}
                
                {% if user_id %}
                    {% for code_id, code_data in codes.items() %}
                        {% if code_data.user_id == user_id and code_data.service == service %}
                            {% if code_data.used %}
                                {% set can_earn = False %}
                                {% set cooldown_remaining = 86400 %}
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                {% endif %}

                <div class="card-action">
                    {% if can_earn %}
                        <button class="get-link-btn" data-service="{{ service }}">
                            üöÄ Get Link
                        </button>
                    {% else %}
                        <div class="cooldown-info">
                            <span class="cooldown-text">Available in 24h</span>
                            <div class="cooldown-timer" data-seconds="{{ cooldown_remaining }}"></div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Recent Activity -->
    <div class="recent-activity">
        <h3>üìà Recent Completions</h3>
        <div class="activity-list">
            {% if completions %}
                {% for completion in completions[-5:] %}
                <div class="activity-item">
                    <span class="activity-service">{{ shorteners[completion.service].name }}</span>
                    <span class="activity-reward">+{{ completion.reward }} üç™</span>
                    <span class="activity-time">{{ completion.timestamp.strftime('%H:%M') }}</span>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-activity">
                    <p>No completions yet. Start earning your first cookies!</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Link Modal -->
<div id="linkModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üîó Complete Your Offer</h3>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <div class="link-instructions">
                <p>Click the link below and complete the offer. Your cookies will be added automatically!</p>
                <div class="tracking-info">
                    <strong>Tracking Code:</strong> <span id="trackingCode"></span>
                </div>
            </div>
            <div class="link-action">
                <a id="offerLink" href="#" target="_blank" class="offer-link-btn">
                    üéØ Complete Offer
                </a>
            </div>
            <div class="verification-section" style="display: none;">
                <button id="verifyBtn" class="verify-btn">
                    ‚úÖ Verify Completion
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.earn-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.earn-header {
    background: white;
    border-radius: 15px;
    padding: 30px;
    text-align: center;
    margin-bottom: 30px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

.earn-header h1 {
    font-size: 3em;
    color: #667eea;
    margin-bottom: 15px;
}

.user-stats {
    display: flex;
    justify-content: center;
    gap: 40px;
    margin-top: 20px;
}

.stat-item {
    text-align: center;
}

.stat-number {
    display: block;
    font-size: 2.5em;
    font-weight: bold;
    color: #28a745;
}

.stat-label {
    color: #666;
    font-size: 0.9em;
}

.instructions-card {
    background: #e3f2fd;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 30px;
    border-left: 5px solid #2196f3;
}

.instruction-steps {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.instruction-steps span {
    background: white;
    padding: 10px;
    border-radius: 8px;
    text-align: center;
    font-weight: 500;
}

.earning-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 25px;
    margin-bottom: 40px;
}

.earning-option-card {
    background: white;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
}

.earning-option-card:hover {
    transform: translateY(-5px);
}

.card-header {
    padding: 20px;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.card-header h3 {
    margin: 0;
    font-size: 1.4em;
}

.reward-badge {
    background: rgba(255,255,255,0.2);
    padding: 8px 15px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 1.1em;
}

.card-body {
    padding: 25px;
}

.service-info p {
    color: #666;
    margin-bottom: 15px;
}

.service-stats {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
}

.service-stats span {
    background: #f8f9fa;
    padding: 5px 12px;
    border-radius: 15px;
    font-size: 0.9em;
    color: #666;
}

.get-link-btn {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 10px;
    font-size: 1.1em;
    font-weight: bold;
    cursor: pointer;
    width: 100%;
    transition: transform 0.2s;
}

.get-link-btn:hover {
    transform: translateY(-2px);
}

.cooldown-info {
    text-align: center;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 10px;
}

.cooldown-text {
    color: #dc3545;
    font-weight: bold;
}

.recent-activity {
    background: white;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

.recent-activity h3 {
    color: #667eea;
    margin-bottom: 20px;
}

.activity-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.activity-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

.activity-reward {
    color: #28a745;
    font-weight: bold;
}

.activity-time {
    color: #666;
    font-size: 0.9em;
}

.no-activity {
    text-align: center;
    padding: 30px;
    color: #666;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: white;
    margin: 10% auto;
    padding: 0;
    border-radius: 15px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
}

.modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 15px 15px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.close {
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.modal-body {
    padding: 30px;
}

.tracking-info {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
    font-family: monospace;
}

.offer-link-btn {
    display: block;
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    padding: 15px;
    border-radius: 10px;
    text-align: center;
    text-decoration: none;
    font-weight: bold;
    font-size: 1.1em;
    margin: 20px 0;
    transition: transform 0.2s;
}

.offer-link-btn:hover {
    transform: translateY(-2px);
}

@media (max-width: 768px) {
    .earning-options {
        grid-template-columns: 1fr;
    }
    
    .user-stats {
        flex-direction: column;
        gap: 20px;
    }
    
    .instruction-steps {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('linkModal');
    const closeBtn = document.querySelector('.close');
    
    // Handle get link buttons
    document.querySelectorAll('.get-link-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const service = this.dataset.service;
            
            fetch(`/get_link/${service}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('offerLink').href = data.url;
                        document.getElementById('trackingCode').textContent = data.code;
                        modal.style.display = 'block';
                        
                        // Show verify button after 30 seconds
                        setTimeout(() => {
                            document.querySelector('.verification-section').style.display = 'block';
                            document.getElementById('verifyBtn').onclick = () => verifyCompletion(data.code);
                        }, 30000);
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('Error generating link. Please try again.');
                });
        });
    });
    
    // Close modal
    closeBtn.addEventListener('click', function() {
        modal.style.display = 'none';
    });
    
    window.addEventListener('click', function(event) {
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    });
});

function verifyCompletion(code) {
    fetch('/verify_completion', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({code: code})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = `/completion/${code}`;
        } else {
            alert('Verification failed: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error verifying completion. Please try again.');
    });
}
</script>
{% endblock %}
